<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Caps</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="terminal">
        <div class="terminal-title">Welcome to Universal Caps !</div>
        <div class="terminal-message" id="terminalMessage" aria-live="polite" aria-atomic="true"></div>
        <button id="resetBtn">Reset Game</button>
    </header>

    <div class="game-container">
        <div>
            <h1>
                Caps : <span id="caps">0</span>
            </h1>

            <button id="MakeCaps" onclick="capsClic(1)">Make Cap</button>

            <div id="businessDiv">
                <div>
                    <b>Business</b>
                </div>
                
                Available Funds: $ <span id="funds">0.00</span><br>
                Unsold Inventory: <span id="unsoldClips">0</span><br> 
                <button id="btnLowerPrice" onclick="lowerPrice()">lower</button>
                <button id="btnRaisePrice" onclick="raisePrice()">raise</button>
                Price per Caps: $ <span id="margin">0.25</span><br>
                Public Demand: <span id="demand">32</span>%<br>
                <br>    
                <button id="btnExpandMarketing" onclick="buyAds()" disabled="">Marketing</button> <span> Level: </span><span id="marketingLvl">1</span><br>
                Cost: $ <span id="adCost">100.00</span><br>
                <br>    

                <div id="automatisationDiv">
                    <div class="auto-header">
                        <b>Automatisation Section</b>
                        <hr>
                    </div>
                    <button id="BuyAutoCapser" disabled="">Buy AutoCapser</button> 
                    Price : $ <span id="priceAutoCapser">15</span>

                </div>
                
            </div>
        </div>

        <div id="itResourcesDiv" class="itResourcesDiv">
            <h2>IT Resources</h2>

            <div><b>Trust:</b> <span id="trust">0</span></div>
            <div><b>Next Trust at:</b> <span id="nextTrust">1 000</span> caps</div>

            <br>

            <div><b>Ops:</b> <span id="ops">0</span> / <span id="opsMax">1000</span></div>

            <br>

            <button id="btnBuyCPU" onclick="buyCPU()" disabled>Buy CPU (1 Trust)</button>
            <span> CPUs: <span id="cpuCount">1</span></span>

            <br><br>

            <button id="btnBuyRAM" onclick="buyRAM()" disabled>Buy RAM (1 Trust)</button>
            <span> RAM: <span id="ramCount">1</span></span>

        </div>
    </div>
    
    <script>
        // ---Variable---

        // compteur de caps simple
        let caps = parseInt(document.getElementById('caps').textContent, 10) || 0;

        let unsold = parseInt(document.getElementById('unsoldClips').textContent) || 0;
        
        let funds = parseFloat(document.getElementById('funds').textContent) || 0;

        // Variables AutoCapser
        let autoCapsers = 0;
        let priceAutoCapser = parseFloat(document.getElementById('priceAutoCapser').textContent);

        let marketingLvl = parseInt(document.getElementById('marketingLvl').textContent) || 1;
        let adCost = parseFloat(document.getElementById('adCost').textContent) || 100;

        // IT Resources
        let trust = parseInt(document.getElementById("trust").textContent) || 0;
        let nextTrustAt = 10000;

        let ops = 0;
        let opsMax = 1000;

        let cpuCount = parseInt(document.getElementById("cpuCount").textContent) || 1;
        let ramCount = parseInt(document.getElementById("ramCount").textContent) || 1;  // RAM 1 = 1000 ops max
        // Nouvelle variable pour suivre si la section a été débloquée
        let itResourcesUnlocked = false;

        // --- Fonction relative aux Sauvergardes ---


        // Début de la session (temps de jeu)
        const sessionStart = Date.now();

        // jalons : 1e3, 1e4, 1e5, 1e6, 1e7, 1e8, 1e9
        const milestones = [1e2, 1e3, 1e4, 1e5, 1e6, 1e7, 1e8, 1e9];
        const reached = new Set();

        function saveGame() {
            localStorage.setItem('caps', caps);
            localStorage.setItem('unsold', unsold);
            localStorage.setItem('funds', funds);
            localStorage.setItem('autoCapsers', autoCapsers);
            localStorage.setItem('priceAutoCapser', priceAutoCapser);
            localStorage.setItem('marketingLvl', marketingLvl);
            localStorage.setItem('adCost', adCost);
            
            // --- NOUVEAU : Sauvegarde des ressources IT ---
            localStorage.setItem('trust', trust);
            localStorage.setItem('nextTrustAt', nextTrustAt);
            localStorage.setItem('ops', ops);
            // opsMax, cpuCount, et ramCount sont recalculés par loadGame, mais on peut les sauver
            localStorage.setItem('cpuCount', cpuCount);
            localStorage.setItem('ramCount', ramCount);
            localStorage.setItem('itResourcesUnlocked', itResourcesUnlocked); // Sauvegarder l'état du déblocage
            // ----------------------------------------------

            // Sauvegarde du temps de jeu total
            const elapsed = Date.now() - sessionStart; 
            const prevElapsed = parseInt(localStorage.getItem('elapsed')) || 0;
            localStorage.setItem('elapsed', prevElapsed + elapsed);
        }

        function loadGame() {
                    caps = parseInt(localStorage.getItem('caps')) || 0;
            unsold = parseInt(localStorage.getItem('unsold')) || 0;
            funds = parseFloat(localStorage.getItem('funds')) || 0;
            autoCapsers = parseInt(localStorage.getItem('autoCapsers')) || 0;
            priceAutoCapser = parseFloat(localStorage.getItem('priceAutoCapser')) || 15;
            marketingLvl = parseInt(localStorage.getItem('marketingLvl')) || 1;
            adCost = parseFloat(localStorage.getItem('adCost')) || 100;
            
            // --- NOUVEAU : Chargement des ressources IT ---
            trust = parseInt(localStorage.getItem('trust')) || 0; // Utiliser 0 si non trouvé
            nextTrustAt = parseInt(localStorage.getItem('nextTrustAt')) || 10000;
            ops = parseInt(localStorage.getItem('ops')) || 0; // La valeur ops est sauvegardée pour la continuité
            cpuCount = parseInt(localStorage.getItem('cpuCount')) || 1;
            ramCount = parseInt(localStorage.getItem('ramCount')) || 1;
            opsMax = ramCount * 1000; // Recalculer opsMax à partir de ramCount
            itResourcesUnlocked = localStorage.getItem('itResourcesUnlocked') === 'true'; // Charger l'état
            // ----------------------------------------------

            const reachedArray = JSON.parse(localStorage.getItem('reached'));
            reached.clear();
            if (reachedArray) {
                for (const m of reachedArray) reached.add(m);
            }

            // **Marquer les milestones déjà dépassées**
            for (const m of milestones) {
                if (caps >= m) reached.add(m);
            }

            // Mettre à jour l’affichage
            document.getElementById('caps').textContent = caps;
            document.getElementById('unsoldClips').textContent = unsold;
            document.getElementById('funds').textContent = funds.toFixed(2);
            document.getElementById('priceAutoCapser').textContent = priceAutoCapser.toFixed(2);
            document.getElementById('marketingLvl').textContent = marketingLvl;
            document.getElementById('adCost').textContent = adCost.toFixed(2);

            // --- NOUVEAU : Mise à jour de l'affichage IT ---
            document.getElementById("trust").textContent = trust;
            document.getElementById("nextTrust").textContent = nextTrustAt.toLocaleString();
            document.getElementById("ops").textContent = ops;
            document.getElementById("cpuCount").textContent = cpuCount;
            document.getElementById("ramCount").textContent = ramCount;
            document.getElementById("opsMax").textContent = opsMax;
            // ------------------------------------------------

            // --- NOUVEAU : Débloquer la section si nécessaire ---
            if (itResourcesUnlocked) {
                unlockITResources(true); // Passer un paramètre pour éviter d'afficher le message "unlocked!" à chaque chargement
            }
            // -----------------------------------------------------

            // Appeler les fonctions pour mettre à jour l'état des boutons après le chargement
            PublicDemand();
            updateAutoCapserButton();
            updateMarketingButton();
            updateCPUButton();
            updateRAMButton();
        }

        // Afficher le message de dernière sauvegarde chargée
        function showLastSaveMessage() {
            const lastCaps = parseInt(localStorage.getItem('caps')) || 0;
            const totalElapsed = parseInt(localStorage.getItem('elapsed')) || 0;
            
            const totalSec = Math.floor(totalElapsed / 1000);
            const hrs = Math.floor(totalSec / 3600);
            const mins = Math.floor((totalSec % 3600) / 60);
            const secs = totalSec % 60;
            const pad = n => String(n).padStart(2,'0');

            if(lastCaps > 0) {
                let timeStr = hrs > 0 ? `${hrs}:${pad(mins)}:${pad(secs)}` : `${mins}:${pad(secs)}`;
                const msg = `Last save loaded: ${lastCaps} caps in ${timeStr} min`;
                showTerminalMessage(msg, 5000);
            }
        }

        function resetGame() {
                    // Réinitialiser les variables
            caps = 0;
            unsold = 0;
            funds = 0;
            autoCapsers = 0;
            priceAutoCapser = 15;
            marketingLvl = 1;
            adCost = 100;

            // --- NOUVEAU : Réinitialisation des ressources IT ---
            trust = 0;
            nextTrustAt = 10000;
            ops = 0;
            cpuCount = 1;
            ramCount = 1;
            opsMax = 1000;
            itResourcesUnlocked = false;
            // ---------------------------------------------------

            reached.clear();
            localStorage.clear(); // supprime toutes les sauvegardes

            // Mettre à jour l'affichage
            document.getElementById('caps').textContent = caps;
            document.getElementById('unsoldClips').textContent = unsold;
            document.getElementById('funds').textContent = funds.toFixed(2);
            document.getElementById('priceAutoCapser').textContent = priceAutoCapser.toFixed(2);
            document.getElementById('marketingLvl').textContent = marketingLvl;
            document.getElementById('adCost').textContent = adCost.toFixed(2);
            document.getElementById('demand').textContent = "0";

            // --- NOUVEAU : Mise à jour de l'affichage IT ---
            document.getElementById("trust").textContent = trust;
            document.getElementById("nextTrust").textContent = nextTrustAt.toLocaleString();
            document.getElementById("ops").textContent = ops;
            document.getElementById("cpuCount").textContent = cpuCount;
            document.getElementById("ramCount").textContent = ramCount;
            document.getElementById("opsMax").textContent = opsMax;
            document.getElementById('itResourcesDiv').style.display = 'none'; // Cacher la section IT
            // ------------------------------------------------

            showTerminalMessage("Game reset ! All values set to 0", 5000);

            // Redémarrer la session
            // sessionStart = Date.now(); // Déclarer 'let sessionStart' si vous voulez faire ça
        }

        // lier le bouton à la fonction
        document.getElementById('resetBtn').onclick = resetGame; 



        // Appelle la fonction au chargement
        showLastSaveMessage();

        // Charger la save
        loadGame();

        // --- Fonction de Jeu ---

        function formatElapsed(ms){
            const totalSec = Math.floor(ms / 1000);
            const hrs = Math.floor(totalSec / 3600);
            const mins = Math.floor((totalSec % 3600) / 60);
            const secs = totalSec % 60;
            const pad = n => String(n).padStart(2,'0');
            return hrs > 0 ? `${pad(hrs)}:${pad(mins)}:${pad(secs)}` : `${pad(mins)}:${pad(secs)}`;
        }

        function showTerminalMessage(text, duration = 5000){
            const el = document.getElementById('terminalMessage');
            if(!el) return;
            el.textContent = text;
            el.classList.add('visible');
            // retirer après duration
            clearTimeout(el._hideTimeout);
            el._hideTimeout = setTimeout(()=>{
                el.classList.remove('visible');
            }, duration);
        }

        function checkMilestones() {
            const prevElapsed = parseInt(localStorage.getItem('elapsed')) || 0;
            const sessionElapsed = Date.now() - sessionStart;
            const totalElapsed = prevElapsed + sessionElapsed;

            for (const m of milestones) {
                if (caps >= m && !reached.has(m)) {
                    reached.add(m);
                    const timeStr = formatElapsed(totalElapsed);
                    showTerminalMessage(`Congrats ! ${m.toLocaleString()} caps in ${timeStr}`);
                }
            }
        }

        function capsClic(n){
            caps += n;
            unsold += n; // On ajoute à l'inventaire
            document.getElementById('caps').textContent = caps;
            document.getElementById('unsoldClips').textContent = unsold;
            checkMilestones();
            checkTrustGain();

            // Afficher IT Resources si caps >= 1000
            if (caps >= 1000) {
                unlockITResources();
            }
        }


        

        function lowerPrice() {
            const marginSpan = document.getElementById('margin');
            let price = parseFloat(marginSpan.textContent.replace(',', '.'));
            price = Math.max(0.01, price - 0.01);
            marginSpan.textContent = price.toFixed(2);
            PublicDemand();

        }

        function raisePrice() {
            const marginSpan = document.getElementById('margin');
            let price = parseFloat(marginSpan.textContent.replace(',', '.'));
            price = Math.max(0.01, price + 0.01);
            marginSpan.textContent = price.toFixed(2);
            PublicDemand();

        }

        function PublicDemand() {
            const price = parseFloat(document.getElementById('margin').textContent.replace(',', '.'));

            // Fonction agressive de base
            let demand = 200 * Math.exp(-10 * price);

            // Bonus marketing : chaque niveau augmente la demande de 5% (ou plus si tu veux)
            demand *= 1 + 0.05 * marketingLvl;

            // Clamp entre 0 et 200% (ou 200% + marketing si tu veux dépasser)
            demand = Math.max(0, Math.min(500, demand)); // j'ai mis 500 max pour le bonus marketing

            document.getElementById('demand').textContent = demand.toFixed(0);
        }


        function autoSell() {

            const demand = parseFloat(document.getElementById('demand').textContent); // %
            const price = parseFloat(document.getElementById('margin').textContent);

            if (unsold <= 0 || demand <= 0) return;

            // Calcul des caps vendus (demande agressive)
            let sold = Math.floor(unsold * (demand / 100));

            // Update inventaire
            unsold -= sold;
            document.getElementById('unsoldClips').textContent = unsold;

            // Gains
            const revenue = sold * price;
            funds += revenue;

            document.getElementById('funds').textContent = funds.toFixed(2);
        }

        

        // Mettre à jour le bouton AutoCapser selon les fonds et augmenter le prix de façon agressive
        function updateAutoCapserButton() {
            const btn = document.getElementById('BuyAutoCapser');
            btn.disabled = funds < priceAutoCapser;
            
            // Affichage du prix arrondi
            btn.textContent = `Buy AutoCapser ($${priceAutoCapser.toFixed(2)})`;
        }

        // Acheter un AutoCapser avec augmentation agressive du prix
        function buyAutoCapser() {
            if(funds >= priceAutoCapser){
                funds -= priceAutoCapser;
                autoCapsers += 1;

                // Augmentation exponentielle du prix à chaque achat (comme Universal Paperclips)
                priceAutoCapser *= 1.25; // augmente de 25% à chaque achat
                // Optionnel : tu peux utiliser un facteur plus élevé pour rendre ça encore plus agressif
                // priceAutoCapser *= 1.3;

                document.getElementById('funds').textContent = funds.toFixed(2);
                document.getElementById('priceAutoCapser').textContent = priceAutoCapser.toFixed(2);

                updateAutoCapserButton();
            }
        }

        // Ajouter les caps automatiquement chaque seconde
        function autoGenerateCaps() {
            if(autoCapsers > 0){
                const generated = autoCapsers; // 1 caps par AutoCapser par seconde
                caps += generated;
                unsold += generated;

                document.getElementById('caps').textContent = caps;
                document.getElementById('unsoldClips').textContent = unsold;
                checkMilestones();
                checkTrustGain();
            }
            // Afficher IT Resources si caps >= 1000
            if (caps >= 1000) {
                unlockITResources();
            }
        }

        function buyAds() {
            if(funds >= adCost) {
                funds -= adCost;
                marketingLvl += 1;

                // Augmentation agressive du coût pour le niveau suivant (par exemple x3)
                adCost *= 3;

                // Mettre à jour affichage
                document.getElementById('funds').textContent = funds.toFixed(2);
                document.getElementById('marketingLvl').textContent = marketingLvl;
                document.getElementById('adCost').textContent = adCost.toFixed(2);

                // Mettre à jour la demande publique
                PublicDemand();
            }
        }

        function updateMarketingButton() {
            const btn = document.getElementById('btnExpandMarketing');
            btn.disabled = funds < adCost;
        }

        function checkTrustGain() {
            if (caps >= nextTrustAt) {
                trust++;
                document.getElementById('trust').textContent = trust;

                // Nouveau palier ×10
                nextTrustAt += 10000;
                document.getElementById('nextTrust').textContent = nextTrustAt.toLocaleString();

                showTerminalMessage(`New Trust acquired! (${trust} total)`);
            }
        }

        function buyCPU() {
            if (trust <= 0) return;
            trust--;
            cpuCount++;

            document.getElementById("trust").textContent = trust;
            document.getElementById("cpuCount").textContent = cpuCount;

            updateCPUButton();
        }

        function buyRAM() {
            if (trust <= 0) return;
            trust--;
            ramCount++;
            opsMax = ramCount * 1000;

            document.getElementById("trust").textContent = trust;
            document.getElementById("ramCount").textContent = ramCount;
            document.getElementById("opsMax").textContent = opsMax;

            updateRAMButton();
        }

        function updateCPUButton() {
            document.getElementById("btnBuyCPU").disabled = (trust < 1);
        }

        function updateRAMButton() {
            document.getElementById("btnBuyRAM").disabled = (trust < 1);
        }

        // Lancer l’automatisation toutes les secondes
        setInterval(autoGenerateCaps, 1000); // met à jour les autocapser
        setInterval(updateAutoCapserButton, 500); // Met à jour le bouton d'achat d'autocapser
        setInterval(autoSell, 1000); //met à jour l'autosell
        setInterval(updateMarketingButton, 500); // met à jour le bouton level marketing
        setInterval(saveGame, 5000); // sauvegarde toutes les 5 secondes
        setInterval(() => {
            if (ops < opsMax) {
                ops += cpuCount;  // 1 CPU = +1 ops/2 sec
                if (ops > opsMax) ops = opsMax;
                document.getElementById("ops").textContent = ops;
            }
        }, 2000);

        function unlockITResources(loading = false) {
            const div = document.getElementById('itResourcesDiv');
            if(div.style.display !== 'block') {
                div.style.display = 'block';
                itResourcesUnlocked = true; // Définir l'état sur débloqué
                updateCPUButton();
                updateRAMButton();
                if(!loading) { // Afficher le message uniquement si ce n'est pas un chargement
                    showTerminalMessage("IT Resources unlocked!");
                }
            }
        }

        // Associer les boutons au fonction
        document.getElementById('BuyAutoCapser').onclick = buyAutoCapser;

        document.getElementById('btnExpandMarketing').onclick = buyAds;

    </script>

</body>
</html>